<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold m-0">TICKET</h1>
  <div class="flex justify-between items-center my-4">
    <p-button
      type="button"
      label="Add TICKET"
      icon="pi pi-plus"
      class="p-button-success"
      (click)="openCreateDialog()"
    ></p-button>
    <input
      pInputText
      type="text"
      (input)="dt.filterGlobal($event.target.value, 'contains')"
      placeholder="Search keyword"
    />
  </div>

  <p-divider></p-divider>

  <div class="card">
    <p-table
      #dt
      stripedRows
      [columns]="cols"
      [value]="allTickets()"
      [scrollable]="true"
      scrollHeight="600px"
      [rows]="10"
      [virtualScroll]="true"
      [virtualScrollItemSize]="120"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      (onFilter)="onFilter($event)"
      [loading]="ticketService.loading()"
    >
      <ng-template #header let-columns>
        <tr>
          @for(column of columns; track column) {
          <th
            [pSortableColumn]="column.field"
            [pSortableColumnDisabled]="!column.isSortable"
            pFrozenColumn
            [frozen]="column.isFrozen"
            [alignFrozen]="column.alignFrozen"
          >
            {{ column.header }}
            @if(column.isSortable) {
            <p-sortIcon field="code" />
            }
          </th>
          }
        </tr>

        <tr>
          <th>
            <p-columnFilter type="text" field="title" [showMenu]="false"></p-columnFilter>
          </th>
          <th>
            <p-columnFilter type="text" field="description" [showMenu]="false"></p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="priority" matchMode="equals" [showMenu]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select
                  [options]="ticketService.getPriorities()"
                  (onChange)="filter($event.value)"
                  optionLabel="label"
                  optionValue="value"
                >
                </p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select
                  id="status"
                  [options]="ticketService.getStatuses()"
                  (onChange)="filter($event.value)"
                  optionLabel="label"
                  optionValue="value"
                ></p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="category" matchMode="equals" [showMenu]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select
                  id="category"
                  [options]="ticketService.categories()"
                  (onChange)="filter($event.value)"
                  optionLabel="name"
                  optionValue="name"
                  [showClear]="true"
                ></p-select>
              </ng-template>
            </p-columnFilter>
          </th>
        </tr>
      </ng-template>

      <ng-template let-ticket let-columns="columns" pTemplate="body">
        <tr class="h-[120px]">
          <!-- Title Column -->
          <td class="min-w-32">
            <div class="font-medium text-900 line-clamp-1 overflow-hidden text-ellipsis">
              {{ ticket.title }}
            </div>
          </td>
          <!-- Description Column -->
          <td class="min-w-32">
            <div class="text-600 line-clamp-1 overflow-hidden text-ellipsis">
              {{ ticket.description }}
            </div>
          </td>
          <!-- Priority Column -->
          <td>{{ ticketService.getPriorityLabel(ticket.priority) }}</td>
          <!-- Status Column -->
          <td>{{ ticketService.getStatusLabel(ticket.status) }}</td>

          <!-- Category Column -->
          <td class="min-w-48">
            <p-tag [value]="ticket.category?.name"></p-tag>
          </td>
          <!-- Created At Column -->
          <td class="min-w-32">
            <div class="text-600">
              {{ ticket.created_at | date : 'shortDate' }}
            </div>
          </td>

          <!-- Actions Column -->
          <td pFrozenColumn [frozen]="true" alignFrozen="right">
            <div class="flex gap-1">
              <button
                pButton
                pRipple
                icon="pi pi-pencil"
                class="p-button-primary p-button-text p-button-sm"
                pTooltip="Edit ticket"
                tooltipPosition="top"
                (click)="onEdit(ticket)"
              ></button>

              <div>
                <button
                  pButton
                  pRipple
                  icon="pi pi-trash"
                  class="p-button-danger p-button-text p-button-sm"
                  pTooltip="Delete ticket"
                  tooltipPosition="top"
                  (click)="onDelete(ticket.id)"
                ></button>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <app-ticket-form [(visible)]="showTicketForm" [ticket]="selectedTicket" (saved)="onTicketSaved()">
  </app-ticket-form>
</div>
